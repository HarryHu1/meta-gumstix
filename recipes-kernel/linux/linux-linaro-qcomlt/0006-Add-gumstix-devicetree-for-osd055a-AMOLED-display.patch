From 7c18a9c0c96636c38651862550d5754fe450e3cb Mon Sep 17 00:00:00 2001
From: haiyi <haiyi.zhou@gumstix.com>
Date: Fri, 22 Feb 2019 16:04:52 -0800
Subject: [PATCH] Add gumstix devicetree for osd055a AMOLED display

---
 arch/arm64/boot/dts/qcom/Makefile                  |   1 +
 .../boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dts  |  23 ++++
 .../boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dtsi | 116 +++++++++++++++++++++
 3 files changed, 140 insertions(+)
 create mode 100644 arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dts
 create mode 100644 arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dtsi

diff --git a/arch/arm64/boot/dts/qcom/Makefile b/arch/arm64/boot/dts/qcom/Makefile
index 312f553..ce874ec 100644
--- a/arch/arm64/boot/dts/qcom/Makefile
+++ b/arch/arm64/boot/dts/qcom/Makefile
@@ -7,6 +7,7 @@ dtb-$(CONFIG_ARCH_QCOM)	+= msm8992-bullhead-rev-101.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= msm8994-angler-rev-101.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= msm8996-mtp.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= apq8016-sbc-gumstix-ov5640.dtb
+dtb-$(CONFIG_ARCH_QCOM)	+= apq8016-sbc-gumstix-osd055a.dtb
 
 always		:= $(dtb-y)
 subdir-y	:= $(dts-dirs)
diff --git a/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dts b/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dts
new file mode 100644
index 0000000..e6448a7
--- /dev/null
+++ b/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dts
@@ -0,0 +1,23 @@
+/*
+ * Copyright (c) 2015, The Linux Foundation. All rights reserved.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 and
+ * only version 2 as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ */
+
+/dts-v1/;
+
+#include "apq8016-sbc.dtsi"
+#include "apq8016-sbc-gumstix-ov5640.dtsi"
+#include "apq8016-sbc-gumstix-osd055a.dtsi"
+
+/ {
+	model = "Qualcomm Technologies, Inc. APQ 8016 SBC";
+	compatible = "qcom,apq8016-sbc", "qcom,apq8016", "qcom,sbc";
+};
diff --git a/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dtsi b/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dtsi
new file mode 100644
index 0000000..44d118b
--- /dev/null
+++ b/arch/arm64/boot/dts/qcom/apq8016-sbc-gumstix-osd055a.dtsi
@@ -0,0 +1,116 @@
+/*
+ * Copyright (C) 2018 Gumstix, Inc. - https://www.gumstix.com/
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 or
+ * (at your option) any later version as published by the Free Software
+ * Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ */
+
+/*
+ * This device tree is for AMOLED touchscreen RM67120 from Gumstix including 
+ * OSD055A-MIPI-DSI (DSI display) and GT1151 (touchscreen controller)
+ *
+ * Since the dragonboard has single DSI interface DSI0, either HDMI or
+ * DSI interface located at High Speed Connector will work, not both
+ * In here, the adv_bridge is disabled (HDMI bridge), and linked the dsi0_out_ts
+ * to panel0_in
+ * 
+ * To make the RM67120 AMOLED screen work:
+ * 1. Instead of the default apq8016-sbc devicetree, 
+ *    build the image with the custom apq8016-sbc-gumstix-osd055a devicetree,
+ * 	  which also includes ov5640 camera support
+ */
+
+// GT1151 Touchscreen controller I2C connections
+&blsp_i2c6 {
+	status = "okay";
+	gt1151@14 {
+		status = "okay";
+		compatible = "goodix,gt1151";
+		reg = <0x14>;
+		interrupt-parent = <&msmgpio>;
+		interrupts = <25 0>;
+
+		irq-gpios = <&msmgpio 25 0>;
+		reset-gpios = <&msmgpio 69 0>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&goodix_int_pull_up &panel_reset_pinctrl>;
+	};
+
+};
+
+// OSD055A AMOLED DSI display connections
+&adv_bridge {
+	status = "disabled";
+};
+
+&dsi0 {
+	status = "okay";
+
+	panel@0 {
+		status = "okay";
+		compatible = "osd,osd055a";
+		reg = <0>;
+
+		// Use GPIO32 to mux dis0 to High Speed Connector instead of the HDMI bridge
+		pinctrl-names = "default";
+		pinctrl-0 = <&dsi_out_switch_high>;
+
+		port {
+			panel0_in: endpoint {
+				remote-endpoint = <&dsi0_out>;
+			};
+		};
+	};
+	ports {
+		port@1 {
+			status = "okay";
+			dsi0_out: endpoint {
+				remote-endpoint = <&panel0_in>;
+			};
+		};
+	};
+};
+
+&msmgpio {
+	dsi_out_switch_high: dsi_out_switch_high {
+		pinmux {
+			function = "gpio";
+			pins = "gpio32";
+		};
+		pinconf {
+			pins = "gpio32";
+			drive-strength = <16>;
+			output-high;
+		};
+	};
+	panel_reset_pinctrl: panel_reset_pinctrl {
+		pinmux {
+			function = "gpio";
+			pins = "gpio69";
+		};
+		pinconf {
+			pins = "gpio69";
+			drive-strength = <16>;
+			bias-pull-up;
+		};
+	};
+	goodix_int_pull_up: goodix_int_pull_up {
+		pinmux {
+			function = "gpio";
+			pins = "gpio25";
+		};
+		pinconf {
+			pins = "gpio25";
+			drive-strength = <16>;
+			output-high;
+		};
+	};
+};
\ No newline at end of file
-- 
2.7.4

